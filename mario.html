<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <title>Full Screen Mario</title>
    <link href="mario.css" rel="stylesheet" />
    <link href="Fonts/stylesheet.css" rel="stylesheet" />
    <!-- ‚ú® Google Font for dialogue system -->
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />

    <!-- Refactored libraries/frameworks FIRST -->
    <script src="src/AudioPlayr/AudioPlayr.js"></script>
    <script src="src/TimeHandlr/TimeHandlr.js"></script>
    <script src="src/QuadsKeepr/QuadsKeepr.js"></script>

    <!-- Game scripts in original order -->
    <script src="data.js"></script>
    <script src="editor.js"></script>
    <script src="gamepad.js"></script>
    <script src="generator.js"></script>
    <script src="library.js"></script>
    <script src="load.js"></script>
    <script src="maps.js"></script>
    <script src="mario.js"></script>
    <script src="sprites.js"></script>
    <script src="things.js"></script>
    <script src="toned.js"></script>
    <script src="triggers.js"></script>
    <script src="upkeep.js"></script>
    <script src="utility.js"></script>
    <script src="relationships.js"></script>
    <script src="relationship_scenarios.js"></script>
    <script src="map_modifier.js"></script>
    <script src="dialogue.js"></script>

    <script>
      window.addEventListener("load", function () {
        console.log("üéÆ Initializing AI storytelling systems...");

        // Wait for game to be ready
        setTimeout(function () {
          // Initialize relationship system
          if (window.GameRelationships) {
            GameRelationships.init();
            console.log("‚úÖ GameRelationships initialized");
          }

          // Initialize map modifier
          if (window.MapModifier) {
            MapModifier.init();
            console.log("‚úÖ MapModifier initialized");
          }

          // Initialize flagpole trigger
          if (window.FlagpoleDialogueTrigger) {
            FlagpoleDialogueTrigger.init();
            console.log("‚úÖ FlagpoleDialogueTrigger initialized");
          }

          console.log("‚úÖ All AI systems initialized!");
        }, 2000);
      });
    </script>
  </head>
  <body onload="FullScreenMario()">
    <!-- ‚ú® Relationship Message Box for in-game popups -->
    <div
      id="relationship-message"
      style="
        position: fixed;
        top: 28px;
        left: 0;
        width: 100vw;
        text-align: center;
        font-size: 2em;
        color: #fff;
        background: rgba(0, 0, 0, 0.8);
        padding: 18px 0;
        z-index: 20000;
        font-family: 'Press Start 2P', monospace;
        display: none;
        pointer-events: none;
      "
    ></div>

    <!-- ‚ú® Initialize relationship systems AFTER the game loads -->
    <script>
      // Wait for the game to fully load, then initialize our systems
      window.addEventListener("load", function () {
        setTimeout(function () {
          console.log("üéÆ Game loaded! Initializing relationship systems...");

          function initializeSystems() {
            // Initialize MapModifier
            if (
              window.MapModifier &&
              typeof window.MapModifier.manualInit === "function"
            ) {
              console.log("üó∫Ô∏è Initializing MapModifier...");
              window.MapModifier.manualInit();
              console.log("‚úÖ MapModifier initialized");
            } else {
              console.error("‚ùå MapModifier not found or cannot initialize");
            }

            // Initialize GameRelationships
            if (
              window.GameRelationships &&
              typeof window.GameRelationships.init === "function"
            ) {
              console.log("üíù Initializing GameRelationships...");
              window.GameRelationships.init();
              console.log("‚úÖ GameRelationships initialized");
            }

            console.log("üé≠ All relationship systems ready!");
            console.log("üéÆ Test commands available in console:");
            console.log("   - allyToad(), enemyToad()");
            console.log("   - allyGoomba(), enemyGoomba()");
            console.log("   - allyKoopa(), enemyKoopa()");
            console.log("   - resetAll(), forceReapply()");
            console.log("   - testDeathAndRespawn()");
          }

          // Wait a bit more for everything to be ready, then initialize
          setTimeout(initializeSystems, 500);
        }, 1000); // Wait 1 second for game to initialize
      });

      // Fallback initialization - if the above doesn't work, try this
      setTimeout(function () {
        if (window.MapModifier && !window.MapModifierInitialized) {
          console.log("üîÑ Fallback: Initializing MapModifier...");
          if (typeof window.MapModifier.manualInit === "function") {
            window.MapModifier.manualInit();
            window.MapModifierInitialized = true;
            console.log("‚úÖ MapModifier initialized via fallback");
          }
        }
      }, 3000);
    </script>
  </body>
</html>
