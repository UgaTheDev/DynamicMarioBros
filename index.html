<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <link href="default.css" rel="stylesheet" />
    <link href="Fonts/stylesheet.css" rel="stylesheet" />
    <!-- ‚ú® Google Font for dialogue system -->
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <script src="ui.js"></script>
  </head>
  <body onload="start()">
    <!-- Audio notice (click to enable sound) -->
    <div
      id="audio-notice"
      style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.95);
        color: white;
        padding: 40px;
        border: 4px solid white;
        font-family: 'Press Start 2P', monospace;
        text-align: center;
        z-index: 9999999;
        display: none;
        max-width: 500px;
      "
    >
      <div style="font-size: 24px; margin-bottom: 30px; color: #ffff00">
        Welcome to Super Artificial Bros!
      </div>
      <div style="font-size: 12px; margin-bottom: 30px; line-height: 1.8">
        Click to enable sound and start the game
      </div>
      <button
        onclick="dismissAudioNotice();generateNewLevels()"
        style="
          padding: 15px 40px;
          background: #ff0000;
          color: white;
          border: 3px solid white;
          font-family: 'Press Start 2P', monospace;
          font-size: 14px;
          cursor: pointer;
        "
        onmouseover="this.style.background='#cc0000'"
        onmouseout="this.style.background='#ff0000'"
      >
        START GAME
      </button>
    </div>

    <!-- Top header -->
    <div id="header"></div>

    <!-- Game itself -->
    <iframe id="game" src="mario.html"></iframe>

    <!-- After the game (retracts as needed) -->
    <div id="after">
      <!-- Map Selector popup -->
      <div id="out_mapselect" class="bar1">
        <div class="label">- Map Select -</div>
        <div id="in_mapselect" class="expander"></div>
      </div>
    </div>

    <!-- ‚ú® Debug panel (press 'R' to toggle) -->
    <div
      id="debug-panel"
      style="
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.95);
        color: white;
        padding: 15px;
        z-index: 999999;
        font-family: 'Press Start 2P', monospace;
        font-size: 10px;
        border: 3px solid white;
        display: none;
        min-width: 220px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
      "
    >
      <div
        style="
          margin-bottom: 10px;
          font-size: 12px;
          color: #ffff00;
          text-align: center;
        "
      >
        <strong>üéÆ RELATIONSHIPS</strong>
      </div>

      <div
        style="
          margin: 8px 0;
          padding: 5px;
          background: rgba(255, 0, 0, 0.2);
          border-left: 3px solid #ff0000;
        "
      >
        <span style="color: #ff0000">üçÑ Toad:</span>
        <span id="toad-score" style="float: right; font-weight: bold">0</span>
      </div>

      <div
        style="
          margin: 8px 0;
          padding: 5px;
          background: rgba(139, 69, 19, 0.2);
          border-left: 3px solid #8b4513;
        "
      >
        <span style="color: #8b4513">üëæ Goomba:</span>
        <span id="goomba-score" style="float: right; font-weight: bold">0</span>
      </div>

      <div
        style="
          margin: 8px 0;
          padding: 5px;
          background: rgba(0, 255, 0, 0.2);
          border-left: 3px solid #00ff00;
        "
      >
        <span style="color: #00ff00">üê¢ Koopa:</span>
        <span id="koopa-score" style="float: right; font-weight: bold">0</span>
      </div>

      <div
        style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #333"
      >
        <button
          onclick="testToad()"
          style="
            width: 100%;
            margin: 3px 0;
            padding: 8px;
            background: #ff0000;
            color: white;
            border: 2px solid white;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            cursor: pointer;
          "
          onmouseover="this.style.background='#cc0000'"
          onmouseout="this.style.background='#ff0000'"
        >
          Test Toad Scene
        </button>

        <button
          onclick="testGoomba()"
          style="
            width: 100%;
            margin: 3px 0;
            padding: 8px;
            background: #8b4513;
            color: white;
            border: 2px solid white;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            cursor: pointer;
          "
          onmouseover="this.style.background='#6B3510'"
          onmouseout="this.style.background='#8B4513'"
        >
          Test Goomba Scene
        </button>

        <button
          onclick="testKoopa()"
          style="
            width: 100%;
            margin: 3px 0;
            padding: 8px;
            background: #00ff00;
            color: white;
            border: 2px solid white;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            cursor: pointer;
          "
          onmouseover="this.style.background='#00cc00'"
          onmouseout="this.style.background='#00ff00'"
        >
          Test Koopa Scene
        </button>

        <button
          onclick="resetRelationships()"
          style="
            width: 100%;
            margin: 10px 0 0 0;
            padding: 8px;
            background: #333;
            color: #ff0000;
            border: 2px solid #ff0000;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            cursor: pointer;
          "
          onmouseover="this.style.background='#ff0000'; this.style.color='white'"
          onmouseout="this.style.background='#333'; this.style.color='#ff0000'"
        >
          RESET ALL
        </button>
      </div>

      <div
        style="
          margin-top: 10px;
          padding-top: 10px;
          border-top: 2px solid #333;
          text-align: center;
          font-size: 8px;
          color: #888;
        "
      >
        Press 'R' to toggle
      </div>
    </div>

    <div
      id="loading-screen"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        color: #fff;
        z-index: 99999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        font-family: Arial, sans-serif;
      "
    >
      <h1 style="font-size: 48px; margin-bottom: 20px">üéÆ</h1>
      <h2>Generating New Levels...</h2>
      <p style="margin-top: 10px; opacity: 0.7">This may take 30-60 seconds</p>
      <div
        style="
          margin-top: 20px;
          width: 300px;
          height: 4px;
          background: #333;
          border-radius: 2px;
          overflow: hidden;
        "
      >
        <div
          id="progress-bar"
          style="
            width: 0%;
            height: 100%;
            background: #4caf50;
            animation: progress 60s linear;
          "
        ></div>
      </div>
    </div>

    <style>
      @keyframes progress {
        from {
          width: 0%;
        }
        to {
          width: 90%;
        }
      }
    </style>

    <!-- ‚ú® Scripts for debug panel and iframe communication -->
    <script>
      function dismissAudioNotice() {
        const notice = document.getElementById("audio-notice");
        if (notice) {
          notice.style.display = "none";
        }

        function generateNewLevels() {
          const status = document.getElementById("status");
          if (status) status.textContent = "Generating levels...";

          fetch("/generate-levels", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ worlds: ["12", "13", "14"] }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                if (status)
                  status.textContent =
                    "‚úÖ Levels generated! Reload the page to play them.";
                setTimeout(() => window.location.reload(), 2000);
              } else {
                if (status) status.textContent = "‚ùå Error: " + data.error;
              }
            })
            .catch((error) => {
              if (status) status.textContent = "‚ùå Error: " + error.message;
            });
        }

        try {
          const gameWindow = document.getElementById("game").contentWindow;
          if (gameWindow && gameWindow.AudioPlayer) {
            console.log("Attempting to enable audio...");
          }
        } catch (e) {
          console.log("Audio permission granted");
        }
      }

      window.addEventListener("load", function () {
        setTimeout(function () {
          const notice = document.getElementById("audio-notice");
          if (notice) {
            notice.style.display = "block";
          }
        }, 1000);
      });

      document.addEventListener("keydown", function (e) {
        if (e.key === "r" || e.key === "R") {
          const panel = document.getElementById("debug-panel");
          if (panel) {
            const isVisible = panel.style.display !== "none";
            panel.style.display = isVisible ? "none" : "block";

            if (!isVisible) {
              console.log("üéÆ Debug panel opened");
            }
          }
        }
      });

      setInterval(function () {
        try {
          const gameWindow = document.getElementById("game").contentWindow;

          if (gameWindow && gameWindow.GameRelationships) {
            const scores = gameWindow.GameRelationships.getAll();

            const toadEl = document.getElementById("toad-score");
            const goombaEl = document.getElementById("goomba-score");
            const koopaEl = document.getElementById("koopa-score");

            if (toadEl) toadEl.textContent = scores.toad || 0;
            if (goombaEl) goombaEl.textContent = scores.goomba || 0;
            if (koopaEl) koopaEl.textContent = scores.koopa || 0;

            if (toadEl) {
              toadEl.style.color =
                scores.toad > 30
                  ? "#00ff00"
                  : scores.toad < -30
                  ? "#ff0000"
                  : "#ffffff";
            }
            if (goombaEl) {
              goombaEl.style.color =
                scores.goomba > 30
                  ? "#00ff00"
                  : scores.goomba < -30
                  ? "#ff0000"
                  : "#ffffff";
            }
            if (koopaEl) {
              koopaEl.style.color =
                scores.koopa > 30
                  ? "#00ff00"
                  : scores.koopa < -30
                  ? "#ff0000"
                  : "#ffffff";
            }
          }
        } catch (e) {
          // Ignore errors
        }
      }, 500);

      function testToad() {
        const gameWindow = document.getElementById("game").contentWindow;
        if (gameWindow && gameWindow.testScenario) {
          gameWindow.testScenario("toad");
        } else {
          alert("‚ö†Ô∏è Game not loaded yet!\n\nWait a few seconds and try again.");
        }
      }

      function testGoomba() {
        const gameWindow = document.getElementById("game").contentWindow;
        if (gameWindow && gameWindow.testScenario) {
          gameWindow.testScenario("goomba");
        } else {
          alert("‚ö†Ô∏è Game not loaded yet!\n\nWait a few seconds and try again.");
        }
      }

      function testKoopa() {
        const gameWindow = document.getElementById("game").contentWindow;
        if (gameWindow && gameWindow.testScenario) {
          gameWindow.testScenario("koopa");
        } else {
          alert("‚ö†Ô∏è Game not loaded yet!\n\nWait a few seconds and try again.");
        }
      }

      function resetRelationships() {
        const gameWindow = document.getElementById("game").contentWindow;
        if (gameWindow && gameWindow.GameRelationships) {
          if (
            confirm(
              "‚ö†Ô∏è Reset all relationships to 0?\n\nThis cannot be undone."
            )
          ) {
            gameWindow.GameRelationships.reset();
            console.log("‚úÖ All relationships reset to 0");

            setTimeout(function () {
              alert(
                "‚úÖ Relationships Reset!\n\nAll character relationships are now 0."
              );
            }, 100);
          }
        } else {
          alert("‚ö†Ô∏è Game not loaded yet!\n\nWait a few seconds and try again.");
        }
      }

      window.addEventListener("load", function () {
        setTimeout(function () {
          const panel = document.getElementById("debug-panel");
          if (panel) {
            panel.style.display = "block";
            console.log('üí° Tip: Press "R" key to toggle debug panel');

            setTimeout(function () {
              panel.style.display = "none";
            }, 4000);
          }
        }, 3000);
      });

      console.log(
        "%cüéÆ Full Screen Mario - AI Storytelling Edition",
        "color: #ff0000; font-size: 16px; font-weight: bold;"
      );
      console.log(
        "%cDebug Commands:",
        "color: #00ff00; font-size: 14px; font-weight: bold;"
      );
      console.log("  Press R key - Toggle debug panel");
      console.log("  testToad() - Test Toad story scene");
      console.log("  testGoomba() - Test Goomba story scene");
      console.log("  testKoopa() - Test Koopa story scene");
      console.log("  resetRelationships() - Reset all scores to 0");

      window.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);

        if (!urlParams.has("generated")) {
          const loadingScreen = document.getElementById("loading-screen");
          if (loadingScreen) {
            loadingScreen.style.display = "flex";
          }

          console.log("üéÆ Generating levels... (this takes 30-60 seconds)");

          fetch("/generate-levels", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ worlds: ["12", "13", "14"] }),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("‚úÖ Levels generated!", data);
              window.location.href = window.location.pathname + "?generated=1";
            })
            .catch((error) => {
              console.error("‚ùå Error:", error);
              if (loadingScreen) {
                loadingScreen.style.display = "none";
              }
              alert("Failed to generate levels: " + error.message);
            });
        } else {
          console.log("‚úÖ Playing freshly generated levels!");
        }
      });
    </script>
  </body>
</html>
