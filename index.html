<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <link href="default.css" rel="stylesheet" />
    <link href="Fonts/stylesheet.css" rel="stylesheet" />
    <!-- ‚ú® Google Font for dialogue system -->
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <script src="ui.js"></script>
  </head>
  <body onload="start()">
    <!-- Audio notice (click to enable sound) -->
    <div
      id="audio-notice"
      style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.95);
        color: white;
        padding: 40px;
        border: 4px solid white;
        font-family: 'Press Start 2P', monospace;
        text-align: center;
        z-index: 9999999;
        display: none;
        max-width: 500px;
      "
    >
      <div style="font-size: 24px; margin-bottom: 30px; color: #ffff00">
        Welcome to Super Artificial Bros!
      </div>
      <div style="font-size: 12px; margin-bottom: 30px; line-height: 1.8">
        Click to enable sound and start the game(Check out levels 1-2,1-3,1-4)
      </div>
      <button
        onclick="dismissAudioNotice();generateNewLevels()"
   
        style="
          padding: 15px 40px;
          background: #ff0000;
          color: white;
          border: 3px solid white;
          font-family: 'Press Start 2P', monospace;
          font-size: 14px;
          cursor: pointer;
        "
        onmouseover="this.style.background='#cc0000'"
        onmouseout="this.style.background='#ff0000'"
      >
        START GAME
      </button>
    </div>

    <!-- Top header -->
    <div id="header">
      <!-- <img id="beta" src="Theme/Beta.png"> -->
      <!-- <span id="version"></span> -->
    </div>

    <!-- Game itself -->
    <iframe id="game" src="mario.html"></iframe>
    
    <!-- After the game (retracts as needed) -->
    <div id="after">
      
      <!-- Map Selector popup -->
      <div id="out_mapselect" class="bar1">
        <div class="label">- Map Select -</div>
        <div id="in_mapselect" class="expander"></div>
      </div>
    </div>
    

    <!-- ‚ú® Debug panel (press 'D' to toggle) -->
    <div
      id="debug-panel"
      style="
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.95);
        color: white;
        padding: 15px;
        z-index: 999999;
        font-family: 'Press Start 2P', monospace;
        font-size: 10px;
        border: 3px solid white;
        display: none;
        min-width: 220px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
      "
    >
      <div
        style="
          margin-bottom: 10px;
          font-size: 12px;
          color: #ffff00;
          text-align: center;
        "
      >
        <strong>üéÆ RELATIONSHIPS</strong>
      </div>

      <div
        style="
          margin: 8px 0;
          padding: 5px;
          background: rgba(255, 0, 0, 0.2);
          border-left: 3px solid #ff0000;
        "
      >
        <span style="color: #ff0000">üçÑ Toad:</span>
        <span id="toad-score" style="float: right; font-weight: bold">0</span>
      </div>

      <div
        style="
          margin: 8px 0;
          padding: 5px;
          background: rgba(0, 255, 0, 0.2);
          border-left: 3px solid #00ff00;
        "
      >
        <span style="color: #00ff00">üë® Luigi:</span>
        <span id="luigi-score" style="float: right; font-weight: bold">0</span>
      </div>

      <div
        style="
          margin: 8px 0;
          padding: 5px;
          background: rgba(255, 182, 193, 0.2);
          border-left: 3px solid #ffb6c1;
        "
      >
        <span style="color: #ffb6c1">üëë Peach:</span>
        <span id="peach-score" style="float: right; font-weight: bold">0</span>
      </div>

      <div
        style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #333"
      >
        <button
          onclick="testToad()"
          style="
            width: 100%;
            margin: 3px 0;
            padding: 8px;
            background: #ff0000;
            color: white;
            border: 2px solid white;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            cursor: pointer;
          "
          onmouseover="this.style.background='#cc0000'"
          onmouseout="this.style.background='#ff0000'"
        >
          Test Toad Scene
        </button>

        <button
          onclick="testLuigi()"
          style="
            width: 100%;
            margin: 3px 0;
            padding: 8px;
            background: #00ff00;
            color: white;
            border: 2px solid white;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            cursor: pointer;
          "
          onmouseover="this.style.background='#00cc00'"
          onmouseout="this.style.background='#00ff00'"
        >
          Test Luigi Scene
        </button>

        <button
          onclick="testPeach()"
          style="
            width: 100%;
            margin: 3px 0;
            padding: 8px;
            background: #ffb6c1;
            color: white;
            border: 2px solid white;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            cursor: pointer;
          "
          onmouseover="this.style.background='#ff9eb0'"
          onmouseout="this.style.background='#ffb6c1'"
        >
          Test Peach Scene
        </button>

        <button
          onclick="resetRelationships()"
          style="
            width: 100%;
            margin: 10px 0 0 0;
            padding: 8px;
            background: #333;
            color: #ff0000;
            border: 2px solid #ff0000;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            cursor: pointer;
          "
          onmouseover="this.style.background='#ff0000'; this.style.color='white'"
          onmouseout="this.style.background='#333'; this.style.color='#ff0000'"
        >
          RESET ALL
        </button>
      </div>

      <div
        style="
          margin-top: 10px;
          padding-top: 10px;
          border-top: 2px solid #333;
          text-align: center;
          font-size: 8px;
          color: #888;
        "
      >
        Press 'R' to toggle
      </div>
    </div>

    <!-- ‚ú® Scripts for debug panel and iframe communication -->
    <script>
      // Dismiss audio notice
      function dismissAudioNotice() {
        const notice = document.getElementById("audio-notice");
        if (notice) {
          notice.style.display = "none";
        }
      function generateNewLevels() {
          const status = document.getElementById('status');
          status.textContent = 'Generating levels...';
          
          fetch('/generate-levels', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ worlds: ['12', '13', '14'] })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              status.textContent = '‚úÖ Levels generated! Reload the page to play them.';
              // Optional: automatically reload after 2 seconds
              setTimeout(() => window.location.reload(), 2000);
            } else {
              status.textContent = '‚ùå Error: ' + data.error;
            }
          })
          .catch(error => {
            status.textContent = '‚ùå Error: ' + error.message;
          });
        }

        // Try to unmute/play audio in iframe
        try {
          const gameWindow = document.getElementById("game").contentWindow;
          if (gameWindow && gameWindow.AudioPlayer) {
            // Try to resume audio context
            console.log("Attempting to enable audio...");
          }
        } catch (e) {
          console.log("Audio permission granted");
        }
      }

      // Show audio notice on first load
      window.addEventListener("load", function () {
        setTimeout(function () {
          const notice = document.getElementById("audio-notice");
          if (notice) {
            notice.style.display = "block";
          }
        }, 1000);
      });

      // Toggle debug panel with 'D' key
      document.addEventListener("keydown", function (e) {
        if (e.key === "r" || e.key === "R") {
          const panel = document.getElementById("debug-panel");
          if (panel) {
            const isVisible = panel.style.display !== "none";
            panel.style.display = isVisible ? "none" : "block";

            if (!isVisible) {
              console.log("üéÆ Debug panel opened");
            }
          }
        }
      });

      // Update scores display every 500ms
      setInterval(function () {
        try {
          // Access the iframe's window
          const gameWindow = document.getElementById("game").contentWindow;

          if (gameWindow && gameWindow.GameRelationships) {
            const scores = gameWindow.GameRelationships.getAll();

            // Update display
            const toadEl = document.getElementById("toad-score");
            const luigiEl = document.getElementById("luigi-score");
            const peachEl = document.getElementById("peach-score");

            if (toadEl) toadEl.textContent = scores.toad || 0;
            if (luigiEl) luigiEl.textContent = scores.luigi || 0;
            if (peachEl) peachEl.textContent = scores.peach || 0;

            // Color code based on relationship
            if (toadEl) {
              toadEl.style.color =
                scores.toad > 30
                  ? "#00ff00"
                  : scores.toad < -30
                  ? "#ff0000"
                  : "#ffffff";
            }
            if (luigiEl) {
              luigiEl.style.color =
                scores.luigi > 30
                  ? "#00ff00"
                  : scores.luigi < -30
                  ? "#ff0000"
                  : "#ffffff";
            }
            if (peachEl) {
              peachEl.style.color =
                scores.peach > 30
                  ? "#00ff00"
                  : scores.peach < -30
                  ? "#ff0000"
                  : "#ffffff";
            }
          }
        } catch (e) {
          // Ignore errors (iframe might not be loaded yet)
        }
      }, 500);

      // Test functions that communicate with iframe
      function testToad() {
        const gameWindow = document.getElementById("game").contentWindow;
        if (gameWindow && gameWindow.StoryTrigger) {
          gameWindow.StoryTrigger.test("toad");
        } else {
          alert("‚ö†Ô∏è Game not loaded yet!\n\nWait a few seconds and try again.");
          console.error("StoryTrigger not available in game window");
        }
      }

      function testLuigi() {
        const gameWindow = document.getElementById("game").contentWindow;
        if (gameWindow && gameWindow.StoryTrigger) {
          gameWindow.StoryTrigger.test("luigi");
        } else {
          alert("‚ö†Ô∏è Game not loaded yet!\n\nWait a few seconds and try again.");
          console.error("StoryTrigger not available in game window");
        }
      }

      function testPeach() {
        const gameWindow = document.getElementById("game").contentWindow;
        if (gameWindow && gameWindow.StoryTrigger) {
          gameWindow.StoryTrigger.test("peach");
        } else {
          alert("‚ö†Ô∏è Game not loaded yet!\n\nWait a few seconds and try again.");
          console.error("StoryTrigger not available in game window");
        }
      }

      function resetRelationships() {
        const gameWindow = document.getElementById("game").contentWindow;
        if (gameWindow && gameWindow.GameRelationships) {
          if (
            confirm(
              "‚ö†Ô∏è Reset all relationships to 0?\n\nThis cannot be undone."
            )
          ) {
            gameWindow.GameRelationships.reset();
            console.log("‚úÖ All relationships reset to 0");

            // Show confirmation
            setTimeout(function () {
              alert(
                "‚úÖ Relationships Reset!\n\nAll character relationships are now 0."
              );
            }, 100);
          }
        } else {
          alert("‚ö†Ô∏è Game not loaded yet!\n\nWait a few seconds and try again.");
          console.error("GameRelationships not available in game window");
        }
      }

      // Show debug panel briefly after game loads (so users know it exists)
      window.addEventListener("load", function () {
        setTimeout(function () {
          const panel = document.getElementById("debug-panel");
          if (panel) {
            panel.style.display = "block";
            console.log('üí° Tip: Press "R" key to toggle debug panel');

            // Auto-hide after 4 seconds
            setTimeout(function () {
              panel.style.display = "none";
            }, 4000);
          }
        }, 3000); // Show after 3 seconds (game should be loaded)
      });

      // Console helper functions
      console.log(
        "%cüéÆ Full Screen Mario - AI Storytelling Edition",
        "color: #ff0000; font-size: 16px; font-weight: bold;"
      );
      console.log(
        "%cDebug Commands:",
        "color: #00ff00; font-size: 14px; font-weight: bold;"
      );
      console.log("  Press R key - Toggle debug panel");
      console.log("  testToad() - Test Toad story scene");
      console.log("  testLuigi() - Test Luigi story scene");
      console.log("  testPeach() - Test Peach story scene");
      console.log("  resetRelationships() - Reset all scores to 0");
      console.log(
        "%cGame Window Access:",
        "color: #00ff00; font-size: 14px; font-weight: bold;"
      );
      console.log(
        '  const game = document.getElementById("game").contentWindow;'
      );
      console.log('  game.GameRelationships.update("toad", 50)');
      console.log("  game.GameRelationships.getAll()");
      console.log('  game.StoryTrigger.test("toad")');
    </script>
  </body>
</html>
